#!/bin/bash

#REFERENCES: https://www.baeldung.com/linux/insert-line-specific-line-number


#colors
RED="\x1B[31m"
GRN="\x1B[1;32m"
YEL="\x1B[33m"
BLU="\x1B[34m"
MAG="\x1B[35m"
BMAG="\x1B[1;35m"
CYN="\x1B[36m"
BCYN="\x1B[1;36m"
WHT="\x1B[37m"
RESET="\x1B[0m"
LINEP="\033[40G"

exe=$(find ../ -name miniRT)
incorrect_map=$(find ./ -name incorrect_maps)
incorrect_maps=$(cd $incorrect_map && ls)
A_template=$(find ./ -name A_template)
L_template=$(find ./ -name L_template)
C_template=$(find ./ -name C_template)
cy_template=$(find ./ -name cy_template)
pl_template=$(find ./ -name pl_template)
sp_template=$(find ./ -name sp_template)
normal_template=$(find ./ -name normal_template)

A_cases=$(find ./ -name A_cases)
L_cases=$(find ./ -name L_cases)
C_cases=$(find ./ -name C_cases)
cy_cases=$(find ./ -name cy_cases)
pl_cases=$(find ./ -name pl_cases)
sp_cases=$(find ./ -name sp_cases)
random_cases=$(find ./ -name random_cases)

mkdir -p logs
parsing_log=logs/parsing.log
echo > $parsing_log


random_case_test ()
{
	name=$(basename $1)
	case=$1
	template=$2
	echo -e "${BLU}$name${RESET}"
	while IFS= read -r line; do
		echo -ne "${YEL}${i} - $line:${RESET}"
		random_line=$(shuf -i1-5 -n1)
		sed "$random_line i $line" $template > temp.rt
		timeout --preserve-status 1s $exe temp.rt &> /dev/null
		exit_code=$(echo $?)
		if [[ $exit_code != 1 ]]; then
		echo -e "${RED} KO ${RESET}"
		echo -e "#${i} - $line\nmap\n--------" >> $parsing_log 
		cat temp.rt >> $parsing_log 
		echo -e "\n--------" >> $parsing_log 
		else
		echo -e "${GRN} OK ${RESET}"
		fi
		i=$((i+1))
	done < $case
}

make -C ../ 
i="1"
for map in $incorrect_maps
do
	echo -ne "${YEL}${i} - $map:${RESET}"
	$exe $map 2> /dev/null
	exit_code=$(echo $?)
	if [[ $exit_code != 1 ]]; then
	echo -e "${RED} KO ${RESET}"
	else
	echo -e "${GRN} OK ${RESET}"
	fi
	i=$((i+1))
done

random_case_test $A_cases $A_template
random_case_test $L_cases $L_template
random_case_test $C_cases $C_template
random_case_test $sp_cases $sp_template
random_case_test $pl_cases $pl_template
random_case_test $cy_cases $cy_template


rm -rf temp.rt